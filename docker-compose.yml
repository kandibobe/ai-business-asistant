# docker-compose.yml

version: '3.8' # Указываем версию синтаксиса docker-compose

services:
  # --- Сервис №1: База данных PostgreSQL ---
  db:
    image: postgres:16-alpine  # Используем официальный, легковесный образ PostgreSQL 16
    container_name: ai_bot_postgres_db
    restart: always # Всегда перезапускать контейнер, если он упал
    environment:
      # Эти переменные окружения используются образом postgres для первоначальной настройки
      POSTGRES_USER: ${DB_USER}       # Берем имя пользователя из нашего .env файла
      POSTGRES_PASSWORD: ${DB_PASS}   # Берем пароль из нашего .env файла
      POSTGRES_DB: ${DB_NAME}         # Берем имя базы из нашего .env файла
    ports:
      # Пробрасываем порт 5432 из контейнера на порт 5432 нашего компьютера.
      # Формат: <порт на твоем ПК>:<порт внутри контейнера>
      - "5432:5432"
    volumes:
      # Эта строка "сохраняет" данные базы данных на твоем компьютере.
      # Даже если ты удалишь контейнер, данные останутся в папке postgres_data.
      - ./postgres_data:/var/lib/postgresql/data

  # --- Сервис №2: Брокер сообщений Redis ---
  redis:
    image: redis:7-alpine
    container_name: ai_bot_redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5

  # --- Сервис №3: Telegram Bot ---
  bot:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ai_bot_app
    restart: always
    depends_on:
      db:
        condition: service_started
      redis:
        condition: service_healthy
    env_file:
      - .env
    volumes:
      - ./downloads:/app/downloads
    environment:
      DB_HOST: db
      REDIS_URL: redis://redis:6379/0

  # --- Сервис №4: Celery Worker ---
  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: ai_bot_worker
    restart: always
    depends_on:
      db:
        condition: service_started
      redis:
        condition: service_healthy
    env_file:
      - .env
    volumes:
      - ./downloads:/app/downloads
    environment:
      DB_HOST: db
      REDIS_URL: redis://redis:6379/0

volumes:
  postgres_data:
  redis_data: